# 24. Write Barrier

## 核心ポイント
**ポインタ書き込みを GC に通知する安全装置。コンパイラが自動挿入する。**

## Write Barrier とは

Concurrent GC（アプリと並行して動く GC）では、
マーキング中にアプリがポインタを書き換える可能性がある。

→ 「黒いオブジェクトから白いオブジェクトへのポインタ」が生まれると、
白いオブジェクトが誤って回収されてしまう。

Write Barrier は**ポインタフィールドへの書き込み時に GC に通知**し、
三色不変条件を維持する。

## 仕組み

```
// コンパイラが自動的に挿入:
obj.field = newPtr
↓
writeBarrier(obj, offset, newPtr)  // GC に通知
obj.field = newPtr
```

## パフォーマンス影響

- ポインタ書き込みごとに数ナノ秒のオーバーヘッド
- **スタック上のポインタには不要**（GC がスキャンで処理）
- ポインタを持たない構造体は write barrier が不要 → GC 負荷が低い

## 実務での影響

- ポインタを多く持つ構造体は GC 負荷が高い
- `[]byte` は `[]*byte` より GC に優しい
- struct のフィールドをポインタでなく値にすると GC 負荷が下がる

## 実行方法

```bash
go run ./24_write_barrier/
```
