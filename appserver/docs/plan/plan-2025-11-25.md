# SQSワーカー ローカル開発環境構築 実装計画書

**作成日**: 2025-11-25
**プラン**: 竹（バランス構成）
**ゴール**: メッセージ受信→処理→削除の一連の流れをローカル環境で確認

---

## 1. 概要

### 1.1 目的
ローカル開発環境でSQSを使ったワーカーの動作確認を行う。LocalStackをSQSエミュレータとして使用し、既存の`pkg/worker`パッケージと統合する。

### 1.2 選択したプラン: 竹（バランス構成）

| 項目 | 内容 |
|------|------|
| インフラ | LocalStack + Docker Compose |
| SQSクライアント | `pkg/aws/sqs/` にシンプル実装 |
| ポーラー | 既存Workerに統合 |
| エントリーポイント | `cmd/worker/main.go` 更新 |
| テスト | AWS CLI でメッセージ送信 |

### 1.3 現状分析

**存在するもの ✅**
- Workerパッケージ（`pkg/worker/worker.go`）
  - セマフォベースの並行処理
  - グレースフルシャットダウン
  - Taskインターフェース
- AWS SDK v2（Cognito用に導入済み）
- ワーカーエントリーポイント（`cmd/worker/main.go`）

**不足しているもの ❌**
- LocalStack設定（compose.yml）
- SQS SDK パッケージ
- SQSクライアント実装
- SQSポーラー実装

---

## 2. アーキテクチャ設計

### 2.1 コンポーネント構成

```
[LocalStack SQS]
       ↓ ReceiveMessages (Long Polling)
  [SQSPoller]
       ↓ messageToTask
    [Task]
       ↓ AddJobAsync
   [Worker]
       ↓ processJob (Goroutine Pool)
[Task.Execute()]
       ↓
[DeleteMessage]
```

### 2.2 ファイル構成

```
backend/
├── pkg/
│   ├── aws/
│   │   └── sqs/
│   │       └── sqs.go              (新規)
│   └── worker/
│       ├── worker.go               (既存、変更なし)
│       ├── poller.go               (新規)
│       └── tasks/
│           └── sqstask/
│               └── sqs_task.go     (新規)
├── cmd/
│   └── worker/
│       └── main.go                 (更新)
└── go.mod                          (更新)

compose.yml                          (更新)
local/
└── localstack/
    └── init-sqs.sh                  (新規)
```

### 2.3 設計原則

1. **既存パターンの踏襲**: Cognitoクライアントと同じ構造でSQSクライアントを実装
2. **疎結合**: SQSポーラーとWorkerを分離、Taskインターフェースを活用
3. **At-Least-Once配信**: Workerへの追加成功時点でメッセージ削除
4. **グレースフルシャットダウン**: コンテキストキャンセル対応

---

## 3. 実装タスク一覧

### フェーズ1: インフラ準備

| タスクID | タスク名 | 成果物 | 依存 |
|----------|----------|--------|------|
| 1-1 | LocalStackサービス追加 | compose.yml | - |
| 1-2 | SQSキュー初期化スクリプト作成 | local/localstack/init-sqs.sh | 1-1 |
| 1-3 | AWS CLI設定ファイル作成 | local/aws/config, credentials | 1-2 |

### フェーズ2: Go依存関係

| タスクID | タスク名 | 成果物 | 依存 |
|----------|----------|--------|------|
| 2-1 | AWS SDK SQSパッケージ追加 | go.mod, go.sum | - |

### フェーズ3: SQSクライアント実装

| タスクID | タスク名 | 成果物 | 依存 |
|----------|----------|--------|------|
| 3-1 | SQSクライアントインターフェース定義 | pkg/aws/sqs/sqs.go | 2-1 |
| 3-2 | ReceiveMessageメソッド実装 | pkg/aws/sqs/sqs.go | 3-1 |
| 3-3 | DeleteMessageメソッド実装 | pkg/aws/sqs/sqs.go | 3-1 |
| 3-4 | SendMessageメソッド実装 | pkg/aws/sqs/sqs.go | 3-1 |
| 3-5 | GetQueueURLメソッド実装 | pkg/aws/sqs/sqs.go | 3-1 |
| 3-6 | ユニットテスト実装 | pkg/aws/sqs/sqs_test.go | 3-2〜3-5 |

### フェーズ4: ワーカー統合

| タスクID | タスク名 | 成果物 | 依存 |
|----------|----------|--------|------|
| 4-1 | SQSメッセージハンドラーインターフェース | pkg/worker/sqs_handler.go | 3-6 |
| 4-2 | SQSポーラー実装 | pkg/worker/poller.go | 4-1 |
| 4-3 | SQSタスク実装 | pkg/worker/tasks/sqstask/sqs_task.go | 4-2 |
| 4-4 | サンプルハンドラー実装 | pkg/worker/tasks/sqstask/sample_handler.go | 4-1 |

### フェーズ5: エントリーポイント更新

| タスクID | タスク名 | 成果物 | 依存 |
|----------|----------|--------|------|
| 5-1 | main.go更新（SQS統合） | cmd/worker/main.go | 4-3, 4-4 |
| 5-2 | 環境変数設定ファイル作成 | .env.worker.example | 5-1 |

### フェーズ6: 動作確認

| タスクID | タスク名 | 成果物 | 依存 |
|----------|----------|--------|------|
| 6-1 | テストメッセージ送信スクリプト | local/scripts/test-sqs-send.sh | 1-3 |
| 6-2 | Docker Compose統合テスト | テスト結果ドキュメント | 5-2, 6-1 |
| 6-3 | E2Eテストシナリオ実施 | テスト結果ドキュメント | 6-2 |

---

## 4. 実装詳細

### 4.1 compose.yml追加内容

```yaml
localstack:
  image: localstack/localstack:latest
  ports:
    - "4566:4566"
  environment:
    SERVICES: sqs
    DEBUG: 1
  volumes:
    - ./local/localstack/init-sqs.sh:/etc/localstack/init/ready.d/init-sqs.sh
```

### 4.2 SQSクライアントインターフェース

```go
type SQS interface {
    ReceiveMessages(ctx context.Context, queueURL string, maxMessages int32, waitTimeSeconds int32) ([]types.Message, error)
    DeleteMessage(ctx context.Context, queueURL string, receiptHandle string) error
    SendMessage(ctx context.Context, queueURL string, messageBody string) (*sqs.SendMessageOutput, error)
    GetQueueURL(ctx context.Context, queueName string) (string, error)
}
```

### 4.3 SQSポーラー設定

```go
type SQSPollerConfig struct {
    QueueURL         string
    MaxMessages      int32         // デフォルト: 10
    WaitTimeSeconds  int32         // デフォルト: 20 (ロングポーリング)
    PollInterval     time.Duration // デフォルト: 1秒
}
```

### 4.4 環境変数

| 変数名 | 説明 | デフォルト値 |
|--------|------|-------------|
| AWS_ENDPOINT_URL | LocalStackエンドポイント | http://localhost:4566 |
| AWS_REGION | AWSリージョン | ap-northeast-1 |
| SQS_QUEUE_NAME | SQSキュー名 | worker-queue |
| SQS_MAX_MESSAGES | 一度に受信する最大メッセージ数 | 10 |
| WORKER_RUNNING_WORKERS | 同時処理ワーカー数 | 5 |

---

## 5. テストケース

### 5.1 正常系

| ID | テスト名 | 期待結果 |
|----|----------|----------|
| TC-001 | ワーカー起動確認 | ログに「worker started」が出力される |
| TC-002 | SQS接続確認 | エラーなくキューURLが取得できる |
| TC-003 | メッセージ受信確認 | 送信したメッセージがワーカーで受信される |
| TC-004 | メッセージ処理確認 | タスクが正常に実行される |
| TC-005 | メッセージ削除確認 | 処理後にメッセージがキューから削除される |
| TC-006 | 並行処理確認 | 最大5つのタスクが同時処理される |

### 5.2 異常系

| ID | テスト名 | 期待結果 |
|----|----------|----------|
| TC-101 | SQS接続失敗 | エラーログ出力、プロセスはクラッシュしない |
| TC-102 | メッセージ処理失敗 | メッセージ削除されず、再処理可能 |
| TC-103 | 不正なJSON | パースエラーログ出力、次のメッセージ処理継続 |
| TC-104 | タイムアウト | コンテキストキャンセル、セマフォ解放 |

---

## 6. 動作確認手順

### 6.1 環境起動

```bash
# LocalStack起動
docker compose up -d localstack

# キュー確認
docker compose exec localstack awslocal sqs list-queues
```

### 6.2 ワーカー起動

```bash
cd backend
go run cmd/worker/main.go
```

### 6.3 テストメッセージ送信

```bash
aws --endpoint-url=http://localhost:4566 sqs send-message \
  --queue-url http://localhost:4566/000000000000/worker-queue \
  --message-body '{"task":"test","data":"hello"}' \
  --region ap-northeast-1
```

### 6.4 確認ポイント

1. ワーカーログに受信メッセージが表示される
2. タスク処理成功ログが出力される
3. メッセージ削除ログが出力される
4. キュー内のメッセージが0になる

---

## 7. 依存関係追加

```bash
cd backend
go get github.com/aws/aws-sdk-go-v2/service/sqs@latest
go mod tidy
```

---

## 8. リスクと対策

| リスク | 対策 |
|--------|------|
| LocalStack起動が遅い | ヘルスチェックを設定 |
| メッセージロスト | At-Least-Once配信、処理完了後に削除 |
| 無限ループ | 不正メッセージはDLQへ移動 |
| リソースリーク | グレースフルシャットダウン実装 |

---

## 9. 今後の拡張（松プランへの移行時）

- Dead Letter Queue対応
- メトリクス収集機能
- Taskfileにワーカー起動タスク追加
- Airでのホットリロード対応
- ヘルスチェックエンドポイント追加

---

## 10. 承認

- [ ] プラン内容の確認
- [ ] 実装開始の承認

**承認者**: _____________
**承認日**: _____________
